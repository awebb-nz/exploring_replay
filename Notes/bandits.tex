\documentclass{article}

\usepackage[margin=0.8in]{geometry}
\usepackage{amsmath, amsfonts}
\usepackage{booktabs}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{tikz}
\tikzset{block/.style ={rectangle,draw}
}
\usetikzlibrary{positioning, shapes.geometric}

\setlength{\parindent}{0pt}

\begin{document}

\section*{EVB Decomposition}
Change in the value function due to learning after taking action $a^*$:

\begin{align}
v(ba^*)-v(b)=&\sum_{b'}p(b'\mid b, a^*)\Big(v(b')-v(b)\Big)\\
=&\sum_{b'}p(b'\mid b, a^*)\Big(\sum_a \pi(a\mid b')q(b', a)-\sum_{a} \pi(a\mid b)q(b,a)\Big) \nonumber \\
=&\sum_{b'}p(b'\mid b, a^*)\sum_a\Big(\big(\pi(a\mid b')-\pi(a\mid b)\big)q(b',a) \nonumber \\
+&\pi(a\mid b)\big(q(b', a) - q(b, a)\big)\Big) \nonumber
\end{align}

Expanding $q(b', a) - q(b, a)$:

\begin{align}
q(b', a)-q(b, a)=&\sum_{b''}p(b''\mid b', a)\big[r(b',a) + \gamma v(b'')\big]\\
-&\sum_{b'}p(g'\mid b, a)\big[r(b,a) + \gamma v(g')\big]\nonumber\\
=& r(b',a) + \gamma \sum_{b''}p(b''\mid b', a)v(b'')\nonumber \\
-& r(b,a) + \gamma \sum_{g'}p(g'\mid b, a)v(g')\nonumber \\
=& \underbrace{\vphantom{ \left(\frac{a^{\frac{0.3}{`}}}{b}\right)} r(b',a) - r(b,a)}_{\substack{\text{Difference in the expected} \\ \text{immediate return}}} + \underbrace{\gamma \big[ \sum_{b''}p(b''\mid b', a)v(b'') - \sum_{g'}p(g'\mid b, a)v(g') \big]}_{\substack{\text{Difference in the expected} \\ \text{future return}}}\nonumber
\end{align}

So overall the EVB decomposes as:

\begin{align}
    v(ba^*)-v(b) =& \mathbb{E}_{b'\sim p(b'\mid b, a^*)}\Big[\sum_a \big(\pi(a\mid b')-\pi(a\mid b)\big)q(b',a) \\
    +& \mathbb{E}_{a\sim \pi(a\mid b)}\big[r(b',a) - r(b,a)\big] \nonumber \\ 
    +& \mathbb{E}_{a\sim \pi(a\mid b)}\big[\gamma \sum_{b''}p(b''\mid b', a)v(b'') - \gamma \sum_{g'}p(g'\mid b, a)v(g') \big] \Big] \nonumber
\end{align}

One last thing to consider is how the prioritisation of distal experiences should 
differ from those that are more immediate. This also has implications for how likely 
those experiences are to occur according to the current model. 
\bigbreak
For instance, if the agent considers updating $v(b)$ towards the value that would result 
from taking a particular action from that belief state -- say, $v(ba^*)$ -- the EVB associated 
with that update needs to be weighted by the probability of transitioning into 
belief state $b$ in the first place (i.e., from the current root of the tree).

\begin{align}
    v(ba^*)-v(b) = p(b_{\text{root}}\rightarrow b) &\mathbb{E}_{b'\sim p(b'\mid b, a^*)}\Big[\sum_a \big(\pi(a\mid b')-\pi(a\mid b)\big)q(b',a) \\
    +& \mathbb{E}_{a\sim \pi(a\mid b)}\big[r(b',a) - r(b,a)\big] \nonumber \\ 
    +& \mathbb{E}_{a\sim \pi(a\mid b)}\big[\gamma \sum_{b''}p(b''\mid b', a)v(b'') - \gamma \sum_{g'}p(g'\mid b, a)v(g') \big] \Big] \nonumber
\end{align}

\newpage
\section*{Simulations}

Prioritisation pattern with horizon $h=2$.
\vspace{1cm}

\input{../Data/Tree/tex_tree.tex}

\end{document}
